---
import { Image } from 'astro:assets';
import hangar from '../assets/images/p_1_hangar.png';
import valrhona from '../assets/images/p_2_valrhona.png';
import montgillet from '../assets/images/p_3_montgillet.png';
import sablesienne from '../assets/images/p_4_sablesienne.png';
import sillery from '../assets/images/p_5_sillery.png';
import epicurien from '../assets/images/p_6_epicurien.png';
import poisson from '../assets/images/p_7_poisson.png';
import silvain from '../assets/images/p_8_silvain.png';
import milliat from '../assets/images/p_9_milliat.png';
import secrets from '../assets/images/p_10_secrets.png';
import vie from '../assets/images/p_11_vie.png';
import comptoir from '../assets/images/p_12_comptoir.png';

const partners = [
  { name: "Le Hangar - Artisan biscuitier", logo: hangar, url: "https://laled.eu/" },
  { name: "Valrhona - Chocolats d'exception", logo: valrhona, url: "https://www.valrhona.com/fr-FR" },
  { name: "Montgillet - Domaine familial", logo: montgillet, url: "https://www.montgilet.com/" },
  { name: "La Sablésienne - Biscuiterie depuis 1962", logo: sablesienne, url: "https://sablesienne.com/en" },
  { name: "Les Délices de Sillery - Biscuiterie Bretonne & inclusive", logo: sillery, url: "https://lesdelicesdesillery.fr/" },
  { name: "L'Épicurien - Artisan du goût", logo: epicurien, url: "https://epicurien.com/en/pages/nous" },
  { name: "Poisson d'Ouest - Fabrication artisanale", logo: poisson, url: "https://www.poissondouest.com/" },
  { name: "Silvain - Nougat d'exception", logo: silvain, url: "https://nougats-silvain.fr/" },
  { name: "Alain Milliat - Jus de dégustation", logo: milliat, url: "https://alain-milliat.com/" },
  { name: "Secrets de Famille - Conserverie artisanale Bretonne", logo: secrets, url: "https://conserverie-artisanale-bretonne.com/" },
  { name: "Vie Vin D'Homme - Marchand de vin", logo: vie, url: "https://www.vievindhomme.fr/" },
  { name: "Comptoir Français du Thé - Fabricant engagé", logo: comptoir, url: "https://comptoir-francais-du-the.fr/" },
];
---

<section class="partners-carousel" aria-label="Nos partenaires">
  <h2 class="carousel-title">Nos partenaires</h2>

  <div class="carousel-container">
    <button class="carousel-btn carousel-btn--prev" aria-label="Partenaire précédent">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M15 18l-6-6 6-6"/>
      </svg>
    </button>

    <div class="carousel-viewport">
      <div class="carousel-track">
        {partners.map((partner) => (
          <div class="carousel-slide">
            <a href={partner.url} target="_blank" rel="noopener noreferrer" class="carousel-link" data-tooltip={partner.name}>
              <Image src={partner.logo} alt={partner.name} height={100} class="carousel-logo" />
            </a>
          </div>
        ))}
      </div>
    </div>

    <button class="carousel-btn carousel-btn--next" aria-label="Partenaire suivant">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 18l6-6-6-6"/>
      </svg>
    </button>
  </div>

  <div class="carousel-tooltip" aria-hidden="true"></div>
</section>

<style>
  .partners-carousel {
    background-color: var(--color-warm-bg);
    padding: 3rem 2rem;
  }

  .carousel-title {
    font-family: var(--font-heading);
    font-size: 2rem;
    font-weight: 700;
    font-style: italic;
    color: var(--color-text);
    text-align: center;
    margin-bottom: 2rem;
  }

  .carousel-container {
    max-width: 900px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .carousel-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    color: var(--color-orange);
    transition: color 0.2s;
    flex-shrink: 0;
  }

  .carousel-btn:hover {
    color: var(--color-orange-dark);
  }

  .carousel-viewport {
    overflow: hidden;
    flex: 1;
  }

  .carousel-track {
    display: flex;
  }

  .carousel-slide {
    flex: 0 0 33.333%;
    padding: 1rem 2rem;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .carousel-link {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .carousel-logo {
    height: 100px;
    width: auto;
    object-fit: contain;
  }

  .carousel-tooltip {
    position: fixed;
    z-index: 1000;
    background-color: var(--color-text);
    color: var(--color-white);
    font-size: 0.75rem;
    font-family: var(--font-body);
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .carousel-tooltip.visible {
    opacity: 1;
  }

  @media (max-width: 768px) {
    .carousel-slide {
      flex: 0 0 100%;
      padding: 1rem;
    }

    .carousel-logo {
      height: 70px;
    }
  }
</style>

<script>
  const SLIDE_DURATION = 800;
  const AUTOPLAY_INTERVAL = 2000;
  const TOOLTIP_DELAY = 500;
  const TRANSITION = `transform ${SLIDE_DURATION}ms ease-in-out`;

  const section = document.querySelector('.partners-carousel') as HTMLElement;
  const track = section.querySelector('.carousel-track') as HTMLElement;
  const tooltip = section.querySelector('.carousel-tooltip') as HTMLElement;
  const viewport = section.querySelector('.carousel-viewport')!;
  const mobileQuery = window.matchMedia('(max-width: 768px)');

  let isTransitioning = false;
  let isHovered = false;
  let autoplayTimer: ReturnType<typeof setInterval>;
  let tooltipTimer: ReturnType<typeof setTimeout>;

  function getSlidePercent() {
    return mobileQuery.matches ? 100 : 100 / 3;
  }

  function slide(direction: 'next' | 'prev') {
    if (isTransitioning) return;
    isTransitioning = true;
    const percent = getSlidePercent();

    if (direction === 'next') {
      track.style.transition = TRANSITION;
      track.style.transform = `translateX(-${percent}%)`;
      track.addEventListener('transitionend', () => {
        track.style.transition = 'none';
        track.appendChild(track.firstElementChild!);
        track.style.transform = 'translateX(0)';
        isTransitioning = false;
      }, { once: true });
    } else {
      track.style.transition = 'none';
      track.insertBefore(track.lastElementChild!, track.firstElementChild);
      track.style.transform = `translateX(-${percent}%)`;
      track.offsetHeight; // force reflow before animating
      track.style.transition = TRANSITION;
      track.style.transform = 'translateX(0)';
      track.addEventListener('transitionend', () => {
        isTransitioning = false;
      }, { once: true });
    }
  }

  // Autoplay — pauses on hover and when tab is hidden
  function startAutoplay() {
    stopAutoplay();
    if (!isHovered && !document.hidden) {
      autoplayTimer = setInterval(() => slide('next'), AUTOPLAY_INTERVAL);
    }
  }

  function stopAutoplay() {
    clearInterval(autoplayTimer);
  }

  document.addEventListener('visibilitychange', () => {
    document.hidden ? stopAutoplay() : startAutoplay();
  });

  viewport.addEventListener('mouseenter', () => {
    isHovered = true;
    stopAutoplay();
  });

  viewport.addEventListener('mouseleave', () => {
    isHovered = false;
    startAutoplay();
  });

  // Navigation buttons (event delegation)
  section.addEventListener('click', (e) => {
    const btn = (e.target as HTMLElement).closest('.carousel-btn');
    if (!btn) return;
    slide(btn.classList.contains('carousel-btn--next') ? 'next' : 'prev');
  });

  // Tooltip (event delegation on the viewport)
  viewport.addEventListener('mouseover', (e) => {
    const link = (e.target as HTMLElement).closest('.carousel-link') as HTMLElement | null;
    if (!link) return;
    const text = link.dataset.tooltip || '';
    tooltipTimer = setTimeout(() => {
      const rect = link.getBoundingClientRect();
      tooltip.textContent = text;
      tooltip.style.left = `${rect.left + rect.width / 2 - tooltip.offsetWidth / 2}px`;
      tooltip.style.top = `${rect.bottom + 8}px`;
      tooltip.classList.add('visible');
    }, TOOLTIP_DELAY);
  });

  viewport.addEventListener('mouseout', (e) => {
    const link = (e.target as HTMLElement).closest('.carousel-link');
    if (!link) return;
    clearTimeout(tooltipTimer);
    tooltip.classList.remove('visible');
  });

  // Shuffle slide order on each page visit
  const slides = [...track.children];
  for (let i = slides.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    track.appendChild(slides[j]);
  }

  startAutoplay();
</script>
